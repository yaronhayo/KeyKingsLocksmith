---
// Customer reviews section with social proof
import { getCollection } from 'astro:content';
import { companyConfig } from '../../data/company';

export interface Props {
  class?: string;
  limit?: number;
  showRating?: boolean;
  category?: string;
}

const {
  class: className = '',
  limit = 6,
  showRating = true,
  category,
} = Astro.props;

// Fetch reviews from content collection
let allReviews = await getCollection('reviews');

// Filter by category if specified
if (category) {
  allReviews = allReviews.filter(review => {
    const reviewCategory = review.data.category?.toLowerCase();
    return reviewCategory === category.toLowerCase();
  });
}

// For homepage or when no category specified, show by date
// For category pages, randomize to show different reviews each time
let reviews;
if (!category) {
  // Homepage: sort by date to show most recent
  reviews = allReviews
    .filter((r) => r.data.featured || true)
    .sort((a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime())
    .slice(0, limit);
} else {
  // Category pages: randomize to show different reviews each time
  reviews = allReviews
    .sort(() => Math.random() - 0.5)
    .slice(0, limit);
}

const averageRating = companyConfig.content.reviews.averageRating;
const totalReviews = companyConfig.content.reviews.totalReviews;

// Platform badge configurations
const platformBadges = {
  google: {
    name: 'Google',
    icon: 'M488 261.8C488 403.3 391.1 504 248 504 110.8 504 0 393.2 0 256S110.8 8 248 8c66.8 0 123 24.5 166.3 64.9l-67.5 64.9C258.5 52.6 94.3 116.6 94.3 256c0 86.5 69.1 156.6 153.7 156.6 98.2 0 135-70.4 140.8-106.9H248v-85.3h236.1c2.3 12.7 3.9 24.9 3.9 41.4z',
    color: 'text-blue-600',
    bgColor: 'bg-blue-50'
  },
  facebook: {
    name: 'Facebook',
    icon: 'M504 256C504 119 393 8 256 8S8 119 8 256c0 123.78 90.69 226.38 209.25 245V327.69h-63V256h63v-54.64c0-62.15 37-96.48 93.67-96.48 27.14 0 55.52 4.84 55.52 4.84v61h-31.28c-30.8 0-40.41 19.12-40.41 38.73V256h68.78l-11 71.69h-57.78V501C413.31 482.38 504 379.78 504 256z',
    color: 'text-blue-700',
    bgColor: 'bg-blue-50'
  },
  yelp: {
    name: 'Yelp',
    icon: 'M42.9 240.32l99.62 48.61c19.2 9.4 16.2 37.51-4.5 42.71L30.5 358.45a22.79 22.79 0 0 1-28.21-19.6 197.16 197.16 0 0 1 9-85.32 22.8 22.8 0 0 1 31.61-13.21zm44 239.25a199.45 199.45 0 0 0 79.42 32.11A22.78 22.78 0 0 0 192.94 490l3.9-110.82c.7-21.3-25.5-31.91-39.81-16.1l-74.21 82.4a22.82 22.82 0 0 0 4.09 34.09zm145.34-109.92l58.81 94a22.93 22.93 0 0 0 34 5.5 198.36 198.36 0 0 0 52.71-67.61A23 23 0 0 0 364.17 370l-105.42-34.26c-20.31-6.5-37.81 15.8-26.51 33.91zm148.33-132.23a197.44 197.44 0 0 0-50.41-69.31 22.85 22.85 0 0 0-34 4.4l-62 91.92c-11.9 17.7 4.7 40.61 25.2 34.71L366 268.63a23 23 0 0 0 14.61-31.21zM62.11 30.18a22.86 22.86 0 0 0-9.9 32l104.12 180.44c11.7 20.2 42.61 11.9 42.61-11.4V22.88a22.67 22.67 0 0 0-24.5-22.8 320.37 320.37 0 0 0-112.33 30.1z',
    color: 'text-orange-600',
    bgColor: 'bg-orange-50'
  },
  website: {
    name: 'Website',
    icon: 'M352 256c0 22.2-1.2 43.6-3.3 64H163.3c-2.2-20.4-3.3-41.8-3.3-64s1.2-43.6 3.3-64H348.7c2.2 20.4 3.3 41.8 3.3 64zm28.8-64H503.9c5.3 20.5 8.1 41.9 8.1 64s-2.8 43.5-8.1 64H380.8c2.1-20.6 3.2-42 3.2-64s-1.1-43.4-3.2-64zm112.6-32H376.7c-10-63.9-29.8-117.4-55.3-151.6c78.3 20.7 142 77.5 171.9 151.6zm-149.1 0H167.7c6.1-36.4 15.5-68.6 27-94.7c10.5-23.6 22.2-40.7 33.5-51.5C239.4 3.2 248.7 0 256 0s16.6 3.2 27.8 13.8c11.3 10.8 23 27.9 33.5 51.5c11.6 26 20.9 58.2 27 94.7zm-209 0H18.6C48.6 85.9 112.2 29.1 190.6 8.4C165.1 42.6 145.3 96.1 135.3 160zM8.1 192H131.2c-2.1 20.6-3.2 42-3.2 64s1.1 43.4 3.2 64H8.1C2.8 299.5 0 278.1 0 256s2.8-43.5 8.1-64zM194.7 446.6c-11.6-26-20.9-58.2-27-94.6H344.3c-6.1 36.4-15.5 68.6-27 94.6c-10.5 23.6-22.2 40.7-33.5 51.5C272.6 508.8 263.3 512 256 512s-16.6-3.2-27.8-13.8c-11.3-10.8-23-27.9-33.5-51.5zM135.3 352c10 63.9 29.8 117.4 55.3 151.6C112.2 482.9 48.6 426.1 18.6 352H135.3zm358.1 0c-30 74.1-93.6 130.9-171.9 151.6c25.5-34.2 45.2-87.7 55.3-151.6H493.4z',
    color: 'text-charcoal-700',
    bgColor: 'bg-charcoal-50'
  }
};
---

<section class={`reviews-section py-16 md:py-20 bg-gradient-to-b from-white to-charcoal-50 ${className}`}>
  <div class="container mx-auto px-4">
    <!-- Section Header -->
    <div class="text-center mb-12">
      <h2 class="text-3xl md:text-4xl lg:text-5xl font-display font-bold text-charcoal-900 mb-4">
        What Our Customers Say
      </h2>
      <p class="text-lg md:text-xl text-charcoal-600 mb-6 max-w-2xl mx-auto">
        Don't just take our word for it - hear from our satisfied customers
      </p>

      {showRating && (
        <div class="flex items-center justify-center gap-3 mb-4">
          <!-- Star Rating -->
          <div class="flex items-center gap-1">
            {[...Array(5)].map((_, i) => (
              <svg
                class={`w-7 h-7 ${i < Math.floor(averageRating) ? 'text-gold-400' : 'text-charcoal-300'}`}
                fill="currentColor"
                viewBox="0 0 20 20"
              >
                <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
              </svg>
            ))}
          </div>
          <span class="text-2xl md:text-3xl font-bold text-charcoal-900">{averageRating}</span>
          <span class="text-charcoal-600 text-lg">({totalReviews}+ reviews)</span>
        </div>
      )}
    </div>

    <!-- Reviews Grid -->
    <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6 md:gap-8">
      {reviews.map((review) => {
        const platform = review.data.platform || 'website';
        const badge = platformBadges[platform as keyof typeof platformBadges] || platformBadges.website;
        
        return (
          <div class="bg-white border-2 border-charcoal-100 rounded-xl p-6 shadow-sm hover:shadow-xl hover:border-gold-400 transition-all duration-300 transform hover:-translate-y-1">
            <!-- Review Header -->
            <div class="flex items-start justify-between mb-4">
              <div class="flex items-center gap-3">
                <!-- Avatar -->
                <div class="w-12 h-12 bg-gradient-to-br from-gold-400 to-gold-500 rounded-full flex items-center justify-center text-white font-bold text-lg flex-shrink-0 shadow-md">
                  {review.data.name.charAt(0)}
                </div>
                <div>
                  <h4 class="font-bold text-charcoal-900">{review.data.name}</h4>
                  <p class="text-sm text-charcoal-600">{review.data.location}</p>
                </div>
              </div>
              {review.data.verified && (
                <span class="inline-flex items-center gap-1 px-2 py-1 bg-trust-green/10 text-trust-green text-xs font-semibold rounded-md border border-trust-green/20">
                  <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M6.267 3.455a3.066 3.066 0 001.745-.723 3.066 3.066 0 013.976 0 3.066 3.066 0 001.745.723 3.066 3.066 0 012.812 2.812c.051.643.304 1.254.723 1.745a3.066 3.066 0 010 3.976 3.066 3.066 0 00-.723 1.745 3.066 3.066 0 01-2.812 2.812 3.066 3.066 0 00-1.745.723 3.066 3.066 0 01-3.976 0 3.066 3.066 0 00-1.745-.723 3.066 3.066 0 01-2.812-2.812 3.066 3.066 0 00-.723-1.745 3.066 3.066 0 010-3.976 3.066 3.066 0 00.723-1.745 3.066 3.066 0 012.812-2.812zm7.44 5.252a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                  </svg>
                  Verified
                </span>
              )}
            </div>

            <!-- Star Rating -->
            <div class="flex items-center gap-1 mb-4">
              {[...Array(5)].map((_, i) => (
                <svg
                  class={`w-5 h-5 ${i < review.data.rating ? 'text-gold-400' : 'text-charcoal-300'}`}
                  fill="currentColor"
                  viewBox="0 0 20 20"
                >
                  <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                </svg>
              ))}
            </div>

            <!-- Service Type -->
            <div class="mb-4 pb-4 border-b border-charcoal-100">
              <p class="text-sm text-charcoal-600">
                Service: <span class="font-semibold text-charcoal-900">{review.data.service}</span>
              </p>
            </div>

            <!-- Review Content -->
            <div class="text-charcoal-700 leading-relaxed mb-4">
              {review.body}
            </div>

            <!-- Footer with Date -->
            <div class="pt-4 border-t border-charcoal-100">
              <p class="text-xs text-charcoal-500">
                {new Date(review.data.date).toLocaleDateString('en-US', { year: 'numeric', month: 'short' })}
              </p>
            </div>
          </div>
        );
      })}
    </div>

    <!-- CTA -->
    <div class="text-center mt-16">
      <div class="max-w-3xl mx-auto bg-gradient-to-r from-gold-400 to-gold-500 rounded-2xl p-8 md:p-12 shadow-xl">
        <h3 class="text-2xl md:text-3xl font-display font-bold text-charcoal-900 mb-4">
          Ready to Experience Our Top-Rated Service?
        </h3>
        <p class="text-lg text-charcoal-800 mb-8">
          Join thousands of satisfied customers across Anderson and Upstate SC
        </p>
        <div class="flex flex-wrap justify-center gap-4">
          <a
            href="tel:+18649009597"
            class="inline-flex items-center gap-2 px-8 py-4 bg-charcoal-900 text-white font-bold rounded-lg hover:bg-charcoal-800 transition-all duration-300 transform hover:scale-105 shadow-lg"
          >
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
              <path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z"></path>
            </svg>
            Call (864) 900-9597
          </a>
          <a
            href="/book-service"
            class="inline-flex items-center gap-2 px-8 py-4 bg-white border-2 border-charcoal-900 text-charcoal-900 font-bold rounded-lg hover:bg-charcoal-50 transition-all duration-300 transform hover:scale-105 shadow-lg"
          >
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
            </svg>
            Request Service
          </a>
        </div>
      </div>
    </div>
  </div>
</section>

<style>
  /* Smooth animations for review cards */
  .reviews-section {
    scroll-behavior: smooth;
  }
  
  /* Enhanced hover effects */
  @media (prefers-reduced-motion: no-preference) {
    .reviews-section [class*="hover:-translate-y"] {
      transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
    }
  }
  
  /* Respect reduced motion preferences */
  @media (prefers-reduced-motion: reduce) {
    .reviews-section * {
      animation-duration: 0.01ms !important;
      animation-iteration-count: 1 !important;
      transition-duration: 0.01ms !important;
    }
  }
</style>
